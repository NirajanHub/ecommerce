name: Run Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
#  lint:
#    runs-on: ubuntu-latest
#
#    steps:
#    - uses: actions/checkout@v3
#
#    - name: set up JDK 17
#      uses: actions/setup-java@v3
#      with:
#        java-version: '17'
#        distribution: 'temurin'
#        cache: gradle
#
#    - name: Grant execute permission for gradlew
#      run: chmod +x gradlew
#
#    - name: Run Lint
#      run:  ./gradlew lintDebug
#
#    - name: Upload html test report
#      uses: actions/upload-artifact@v2
#      with:
#        name: lint.html
#        path: app/build/reports/lint-results-debug.html
#
#  unit-test:
#    needs: [lint]
#    runs-on: ubuntu-latest
#    steps:
#      - name: checkout of the code
#        uses: actions/checkout@v3
#
#      - name: set up JDK 17
#        uses: actions/setup-java@v3
#        with:
#          java-version: '17'
#          distribution: 'temurin'
#          cache: gradle
#
#      - name: Run micro-tests
#        run: ./gradlew test
#
#      - name: Grant execute permission for gradlew
#        run: chmod +x gradlew
#
#      - name: Upload test reports
#        uses: actions/upload-artifact@v2
#        with:
#          name: unit_test_report
#          path: app/build/reports/tests/testDebugUnitTest/

  deploy-to-alpha:
#    needs: [unit-test]
    runs-on: ubuntu-latest
    steps:
      - name: checkout of the code
        uses: actions/checkout@v2

      - name:  Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant gradle rights
        run: chmod +x ./gradlew

      - name: Build
        run: ./gradlew build

      - name: Assemble Release Bundle
        run: |
          ./gradlew bundleRelease

      - name: Sign Release
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/bundle/release
          signingKeyBase64: ${{secrets.SIGNINGKEY}}
          alias: ${{secrets.ALIAS}}
          keyStorePassword: ${{secrets.KEYSTOREPASSWORD}}
          keyPassword: ${{secrets.KEYPASSWORD}}

      - name: Deploy to Alpha
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{secrets.SERVICE_ACCOUNT}}
          packageName: com.ncodes.ecommerce
          track: internal
          status: draft
          whatsNewDirectory: distribution/whatsNewDirectory/
          releaseName: 2.1
          releaseFiles: app/build/outputs/bundle/release/app-release.aab





#  instrumentation-test:
#    needs: [unit-test]
#    runs-on: macos-latest
#    steps:
#      - name: Checkout the code
#        uses: actions/checkout@v2
#
#      - name: Run espresso tests
#        uses: reactivecircus/android-emulator-runner@v2
#        with:
#          api-level: 29
#          script: ./gradlew connectedCheck
#
#      - name: Upload test report
#        uses: actions/upload-artifact@v2
#        with:
#          name: instrumentation_test_report
#          path: app/build/reports/androidTests/connected/